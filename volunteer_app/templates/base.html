{% load static %}
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="แพลตฟอร์มระบบจิตอาสา Volunteer System จัดการกิจกรรมและกลุ่มจิตอาสา">
  <title>{% block title %}Volunteer System{% endblock %}</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#41A67E',
            darkBlue: '#05339C',
            blue: '#1055C9',
            gold: '#E5C95F',
          },
          fontFamily: {
            'thai': ['Sarabun', 'Noto Sans Thai', 'sans-serif'],
          },
          boxShadow: {
            'nav': '0 4px 6px -1px rgba(0,0,0,0.1)',
            'card': '0 10px 15px -3px rgba(0,0,0,0.1)',
          }
        },
      },
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'volunteer_app/css/styles_main.css' %}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-800 font-thai min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-primary shadow-nav sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-4 py-3">
      <a href="{% url 'volunteer_app:index' %}" class="text-white font-bold text-2xl hover:text-gold transition-colors">
        Volunteer System
      </a>

      <div class="hidden md:flex items-center space-x-6">
        <a href="{% url 'volunteer_app:activities' %}" class="text-white hover:text-gold transition-colors">กิจกรรมทั้งหมด</a>
        <a href="{% url 'volunteer_app:groups' %}" class="text-white hover:text-gold transition-colors">กลุ่ม</a>
        <a href="{% url 'volunteer_app:idea_list' %}" class="text-white hover:text-gold transition-colors">โหวตไอเดีย</a>
        {% if user.is_authenticated %}
          <a href="{% url 'volunteer_app:notifications' %}" class="relative text-white hover:text-gold transition-colors">
            <i class="fas fa-bell text-lg"></i>
            {% if unread_notifications_count|default:0 > 0 %}
              <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{{ unread_notifications_count }}</span>
            {% endif %}
          </a>
        {% endif %}
        {% if user.is_authenticated %}
          <div class="relative group">
            <button class="text-white hover:text-gold flex items-center gap-2">
              <i class="fas fa-user-circle"></i>{{ user.get_short_name|default:user.username }}
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="absolute right-0 mt-0 w-56 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 py-2 z-50">
              <a href="{% url 'volunteer_app:profile' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 flex items-center gap-2">
                <i class="fas fa-user w-4"></i>โปรไฟล์
              </a>
              <a href="{% url 'volunteer_app:change_password' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 flex items-center gap-2">
                <i class="fas fa-key w-4"></i>เปลี่ยนรหัสผ่าน
              </a>
              {% if user.is_staff or user.is_superuser %}
                <a href="{% url 'volunteer_app:admin_dashboard' %}" class="block px-4 py-2 text-darkBlue hover:bg-gray-100 flex items-center gap-2 font-semibold">
                  <i class="fas fa-cog w-4"></i>แดชบอร์ด Admin
                </a>
              {% endif %}
              <form method="POST" action="{% url 'volunteer_app:logout' %}" class="block">
                {% csrf_token %}
                <button type="submit" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center gap-2">
                  <i class="fas fa-sign-out-alt w-4"></i>ออกจากระบบ
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <a href="{% url 'volunteer_app:login' %}" class="text-white hover:text-gold">เข้าสู่ระบบ</a>
          <a href="{% url 'volunteer_app:register' %}" class="text-white hover:text-gold">สมัครสมาชิก</a>
        {% endif %}
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobileMenuBtn" class="md:hidden text-white hover:text-gold">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>

      <!-- Mobile Menu -->
      <div id="mobileMenu" class="md:hidden mt-3 space-y-2 hidden">
        <a href="{% url 'volunteer_app:activities' %}" class="block text-white/90 hover:text-gold">กิจกรรมทั้งหมด</a>
        <a href="{% url 'volunteer_app:groups' %}" class="block text-white/90 hover:text-gold">กลุ่ม</a>
        <a href="{% url 'volunteer_app:idea_list' %}" class="block text-white/90 hover:text-gold">โหวตไอเดีย</a>
        {% if user.is_authenticated %}
          <a href="{% url 'volunteer_app:notifications' %}" class="block text-white/90 hover:text-gold">
            แจ้งเตือน
            {% if unread_notifications_count|default:0 > 0 %}
              <span class="ml-2 inline-flex items-center justify-center text-xs bg-red-500 text-white rounded-full px-2 py-0.5">{{ unread_notifications_count }}</span>
            {% endif %}
          </a>
        {% endif %}
        {% if user.is_authenticated %}
          <div class="border-t border-white/20 pt-2 mt-2">
            <p class="text-white/70 text-sm mb-2">{{ user.get_full_name|default:user.username }}</p>
            <a href="{% url 'volunteer_app:profile' %}" class="block text-white/90 hover:text-gold pl-4">โปรไฟล์</a>
            <a href="{% url 'volunteer_app:change_password' %}" class="block text-white/90 hover:text-gold pl-4">เปลี่ยนรหัสผ่าน</a>
            {% if user.is_staff or user.is_superuser %}
              <a href="{% url 'volunteer_app:admin_dashboard' %}" class="block text-gold font-semibold hover:text-white pl-4 pt-2">⚙️ Admin</a>
            {% endif %}
          </div>
          <form method="POST" action="{% url 'volunteer_app:logout' %}" class="border-t border-white/20 pt-2 mt-2">
            {% csrf_token %}
            <button type="submit" class="text-left w-full text-red-300 hover:text-red-100">ออกจากระบบ</button>
          </form>
        {% else %}
          <a href="{% url 'volunteer_app:login' %}" class="block text-white/90 hover:text-gold">เข้าสู่ระบบ</a>
          <a href="{% url 'volunteer_app:register' %}" class="block text-white/90 hover:text-gold">สมัครสมาชิก</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto mt-6 px-4 flex-1">
    {% block content %}{% endblock %}
  </main>

  {% include "chatbot_widget.html" %}

  <button id="chatbot-toggle"
          class="fixed bottom-6 right-6 rounded-full shadow-2xl bg-gradient-to-r from-blue-600 to-primary text-white w-14 h-14 flex items-center justify-center focus:outline-none focus:ring-4 focus:ring-blue-200 hover:scale-105 transition-transform z-40"
          aria-label="เปิดแชทบอทช่วยเหลือ">
    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v6"></path>
    </svg>
  </button>

  <!-- Footer -->
  <footer class="bg-darkBlue py-6 mt-12">
    <!-- สงวนพื้นที่ footer ไม่มีข้อความหรือไอคอน -->
  </footer>

  <!-- Mobile menu toggle -->
  <script>
    const btn = document.getElementById('mobileMenuBtn');
    const menu = document.getElementById('mobileMenu');
    btn.addEventListener('click', () => menu.classList.toggle('hidden'));
  </script>

  <!-- Custom JS -->
  <script src="{% static 'volunteer_app/js/qr_scanner_main.js' %}"></script>
  <script>
    const chatbotToggle = document.getElementById("chatbot-toggle");
    const chatbotPanel = document.getElementById("chatbot-panel");
    const chatbotClose = document.getElementById("chatbot-close");

    function toggleChatbot(show) {
      if (!chatbotPanel) return;
      const shouldShow = typeof show === "boolean" ? show : chatbotPanel.classList.contains("hidden");
      if (shouldShow) {
        chatbotPanel.classList.remove("hidden", "opacity-0", "translate-y-4");
      } else {
        chatbotPanel.classList.add("opacity-0", "translate-y-4");
        setTimeout(() => chatbotPanel.classList.add("hidden"), 200);
      }
    }

    if (chatbotToggle && chatbotPanel) {
      chatbotToggle.addEventListener("click", () => toggleChatbot());
    }
    if (chatbotClose && chatbotPanel) {
      chatbotClose.addEventListener("click", () => toggleChatbot(false));
    }

    // เปิด chatbot ให้ผู้ใช้เห็นอย่างน้อยครั้งแรก
    const CHATBOT_SESSION_KEY = "volunteer_chatbot_seen";
    try {
      const hasSeen = sessionStorage.getItem(CHATBOT_SESSION_KEY);
      if (!hasSeen && chatbotPanel) {
        setTimeout(() => toggleChatbot(true), 600);
        sessionStorage.setItem(CHATBOT_SESSION_KEY, "1");
      }
    } catch (err) {
      // sessionStorage อาจไม่พร้อมใช้งาน (โหมด private) จึงข้ามไป
      console.warn("Chatbot session storage unavailable:", err);
    }
  </script>
  {% block scripts %}{% endblock %}

</body>
</html>
